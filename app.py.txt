import streamlit as st
import pandas as pd
import re

def convert_to_seconds(time_val):
    """ì‹œê°„ í˜•ì‹(HH:MM:SS ë˜ëŠ” Excel ìˆ«ì)ì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜"""
    if pd.isna(time_val) or time_val == "":
        return 0
    try:
        if isinstance(time_val, (int, float)): # ì—‘ì…€ ìˆ«ì í˜•ì‹ì¼ ê²½ìš°
            return time_val * 86400
        
        time_str = str(time_val).strip()
        parts = list(map(int, re.split('[:.]', time_str)))
        if len(parts) == 3: return parts[0] * 3600 + parts[1] * 60 + parts[2]
        elif len(parts) == 2: return parts[0] * 60 + parts[1]
    except:
        return 0
    return 0

def format_seconds_to_time(seconds):
    """ì´ˆ ë‹¨ìœ„ë¥¼ HH:MM:SS í˜•ì‹ìœ¼ë¡œ ë³€í™˜"""
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    seconds = int(seconds % 60)
    return f"{hours:02d}:{minutes:02d}:{seconds:02d}"

st.set_page_config(page_title="ì‘ì—…ëŸ‰ í•©ì‚° íˆ´", layout="wide")
st.title("ğŸ“Š ì‘ì—…ìë³„ ë…¹ìŒ ì‹œê°„ í•©ì‚° íˆ´ (Lì—´ ì´ë¦„ / Pì—´ ì‹œê°„)")

uploaded_files = st.file_uploader("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["xlsx", "xls"], accept_multiple_files=True)

if uploaded_files:
    results = []
    for uploaded_file in uploaded_files:
        try:
            # Pì—´(15)ê³¼ Lì—´(11)ë§Œ ì½ì–´ì˜¤ê¸°
            df = pd.read_excel(uploaded_file)
            
            # Lì—´(ì‘ì—…ì ì´ë¦„)ê³¼ Pì—´(ë…¹ìŒ ì‹œê°„) ì¶”ì¶œ
            # ilocëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ L=11, P=15
            worker_names = df.iloc[:, 11] 
            time_data = df.iloc[:, 15]
            
            # íŒŒì¼ ë‚´ ì²« ë²ˆì§¸ ì‘ì—…ì ì´ë¦„ì„ ëŒ€í‘œ ì´ë¦„ìœ¼ë¡œ ì„¤ì • (í˜¹ì€ í–‰ë³„ ë§¤ì¹­ ê°€ëŠ¥)
            first_worker = str(worker_names.iloc[0]).strip() if not worker_names.empty else "Unknown"
            
            # Pì—´ ì‹œê°„ í•©ì‚° (ê³µë°± ì œì™¸ ë§ˆì§€ë§‰ ì…€ê¹Œì§€ ìë™ ê³„ì‚°)
            total_seconds = time_data.apply(convert_to_seconds).sum()
            
            results.append({
                "íŒŒì¼ëª…": uploaded_file.name,
                "ì‘ì—…ì": first_worker,
                "ì´ ë…¹ìŒ ì‹œê°„": format_seconds_to_time(total_seconds),
                "seconds": total_seconds
            })
        except Exception as e:
            st.error(f"{uploaded_file.name} ì˜¤ë¥˜: {e}")

    if results:
        final_df = pd.DataFrame(results)
        st.subheader("ğŸ“‹ íŒŒì¼ë³„ ê²°ê³¼")
        st.dataframe(final_df[["íŒŒì¼ëª…", "ì‘ì—…ì", "ì´ ë…¹ìŒ ì‹œê°„"]], use_container_width=True)
        
        st.subheader("ğŸ‘¤ ì‘ì—…ìë³„ ìµœì¢… í•©ê³„")
        summary = final_df.groupby("ì‘ì—…ì")["seconds"].sum().reset_index()
        summary["ìµœì¢… í•©ì‚° ì‹œê°„"] = summary["seconds"].apply(format_seconds_to_time)
        st.table(summary[["ì‘ì—…ì", "ìµœì¢… í•©ì‚° ì‹œê°„"]])