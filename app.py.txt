import streamlit as st
import pandas as pd
import re

# ì‹œê°„ ë³€í™˜ í•¨ìˆ˜
def convert_to_seconds(time_val):
    if pd.isna(time_val) or time_val == "":
        return 0
    try:
        if isinstance(time_val, (int, float)):
            return time_val * 86400
        time_str = str(time_val).strip()
        parts = list(map(int, re.split('[:.]', time_str)))
        if len(parts) == 3: return parts[0] * 3600 + parts[1] * 60 + parts[2]
        elif len(parts) == 2: return parts[0] * 60 + parts[1]
    except:
        return 0
    return 0

def format_seconds_to_time(seconds):
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    seconds = int(seconds % 60)
    return f"{hours:02d}:{minutes:02d}:{seconds:02d}"

# UI êµ¬ì„±
st.set_page_config(page_title="Work Tracker", layout="wide")
st.title("ğŸ“Š ì‘ì—…ìë³„ ì‹œê°„ í•©ì‚° (Lì—´ ì´ë¦„ / Pì—´ ì‹œê°„)")

files = st.file_uploader("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["xlsx", "xls"], accept_multiple_files=True)

if files:
    results = []
    for f in files:
        try:
            df = pd.read_excel(f)
            # Lì—´(11) ì‘ì—…ì, Pì—´(15) ì‹œê°„
            worker_name = str(df.iloc[0, 11]).strip() if not df.empty else "N/A"
            total_sec = df.iloc[:, 15].apply(convert_to_seconds).sum()
            
            results.append({"File": f.name, "Worker": worker_name, "Seconds": total_sec})
        except Exception as e:
            st.error(f"Error in {f.name}: {e}")

    if results:
        res_df = pd.DataFrame(results)
        res_df["Total Time"] = res_df["Seconds"].apply(format_seconds_to_time)
        st.subheader("ğŸ“‹ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸")
        st.table(res_df[["File", "Worker", "Total Time"]])
        
        st.subheader("ğŸ‘¤ ì‘ì—…ìë³„ ì´í•©")
        summary = res_df.groupby("Worker")["Seconds"].sum().reset_index()
        summary["Grand Total"] = summary["Seconds"].apply(format_seconds_to_time)
        st.table(summary[["Worker", "Grand Total"]])
